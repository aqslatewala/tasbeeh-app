<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abdulqadir Slatewala Tasbeeh Counter</title>
    <!-- PWA / Home Screen Meta -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tasbeeh">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Dynamic Theme Classes */
        .theme-emerald { --primary-rgb: 16, 185, 129; --primary-hex: #10b981; }
        .theme-ruby { --primary-rgb: 225, 29, 72; --primary-hex: #e11d48; }
        .theme-sapphire { --primary-rgb: 37, 99, 235; --primary-hex: #2563eb; }
        .theme-amber { --primary-rgb: 245, 158, 11; --primary-hex: #f59e0b; }
        .theme-rose { --primary-rgb: 219, 39, 119; --primary-hex: #db2677; }

        .text-primary { color: var(--primary-hex); }
        .bg-primary { background-color: var(--primary-hex); }
        .border-primary { border-color: var(--primary-hex); }
        .bg-primary-fade { background-color: rgba(var(--primary-rgb), 0.1); }
        .border-primary-fade { border-color: rgba(var(--primary-rgb), 0.2); }

        /* Background Effects */
        .bg-gradient-dynamic {
            background: linear-gradient(to bottom, #0f172a, #020617);
            position: relative;
            overflow: hidden;
        }

        .dynamic-glow {
            position: absolute;
            width: 80vw;
            height: 80vw;
            background: radial-gradient(circle, rgba(var(--primary-rgb), 0.15) 0%, rgba(var(--primary-rgb), 0) 70%);
            top: -10%;
            right: -10%;
            border-radius: 50%;
            filter: blur(60px);
            transition: background 1s ease;
            pointer-events: none;
            z-index: 0;
            animation: drift 20s infinite alternate ease-in-out;
        }

        .bg-grid {
            position: absolute;
            inset: 0;
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes drift {
            from { transform: translate(0, 0); }
            to { transform: translate(-10%, 10%); }
        }

        .counter-glow {
            text-shadow: 0 0 20px rgba(var(--primary-rgb), 0.3);
        }

        .tap-active:active {
            transform: scale(0.96);
            transition: transform 0.05s;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }

        #modalContent::-webkit-scrollbar {
            display: none;
        }

        .preset-item {
            transition: all 0.2s ease;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .tutorial-highlight::after {
            content: '';
            position: absolute;
            inset: -4px;
            border: 2px solid var(--primary-hex);
            border-radius: inherit;
            animation: pulse-ring 1.5s infinite;
        }

        .modal-base {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        #fireworksCanvas {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 40;
        }
    </style>
</head>
<body id="appBody" class="bg-gradient-dynamic text-white min-h-screen overflow-hidden flex flex-col theme-emerald">
    
    <!-- Fireworks Canvas -->
    <canvas id="fireworksCanvas"></canvas>

    <!-- Decorative Background Layers -->
    <div class="bg-grid"></div>
    <div class="dynamic-glow"></div>

    <!-- Header & Controls -->
    <header class="p-4 flex flex-col gap-4 z-10 bg-slate-950/40 backdrop-blur-md border-b border-white/5">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center transition-colors duration-500">
                    <i data-lucide="hash" class="w-5 h-5 text-slate-950"></i>
                </div>
                <h1 class="font-semibold text-lg tracking-tight">Tasbeeh Counter</h1>
            </div>
            <div class="flex items-center gap-2">
                <!-- Shortcut Button -->
                <button id="shortcutBtn" class="bg-primary-fade text-primary px-3 py-1.5 rounded-full text-[11px] font-bold border border-primary-fade flex items-center gap-1.5 hover:bg-primary-fade/20 transition-all">
                    <i data-lucide="plus-circle" class="w-3.5 h-3.5"></i>
                    Add Shortcut
                </button>
                <!-- Combined Settings Button -->
                <button id="settingsBtn" title="Settings" class="p-2 text-slate-400 hover:text-primary transition-colors">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
                <button id="helpBtn" title="Show Tutorial" class="p-2 text-slate-400 hover:text-primary transition-colors">
                    <i data-lucide="help-circle" class="w-5 h-5"></i>
                </button>
                <div id="userBadge" class="text-[10px] bg-primary-fade px-2 py-1 rounded-full text-primary font-bold hidden border border-primary-fade cursor-pointer transition-colors flex items-center gap-1">
                    <span id="badgeName"></span>
                    <i data-lucide="user-round-pen" class="w-3 h-3"></i>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="grid grid-cols-4 gap-2">
            <button id="resetBtn" class="glass p-2 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors">
                <i data-lucide="rotate-ccw" class="w-4 h-4 text-orange-400"></i>
                <span class="text-[10px] font-medium">Reset</span>
            </button>
            <button id="presetBtn" class="glass p-2 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors">
                <i data-lucide="list-music" class="w-4 h-4 text-blue-400"></i>
                <span class="text-[10px] font-medium">Presets</span>
            </button>
            <button id="historyBtn" class="glass p-2 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors">
                <i data-lucide="history" class="w-4 h-4 text-purple-400"></i>
                <span class="text-[10px] font-medium">History</span>
            </button>
            <button id="finishBtn" class="glass p-2 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors border-primary-fade">
                <i data-lucide="save" class="w-4 h-4 text-primary"></i>
                <span class="text-[10px] font-medium leading-tight">Save</span>
            </button>
        </div>
    </header>

    <!-- Main Interaction Area -->
    <main id="tapArea" class="flex-grow flex flex-col items-center justify-center relative no-select tap-active cursor-pointer p-4 z-10">
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-5">
            <div class="w-64 h-64 border-4 border-primary rounded-full transition-colors duration-500"></div>
        </div>

        <div class="text-center z-10 pointer-events-none flex flex-col items-center gap-2">
            <div id="labelContainer" class="pointer-events-auto cursor-pointer group flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full border border-white/5 hover:border-primary-fade transition-all">
                <span id="labelDisplay" class="text-primary text-sm font-semibold tracking-widest uppercase block transition-colors duration-500">Ya Allah</span>
                <i data-lucide="pencil" class="w-3 h-3 text-primary opacity-0 group-hover:opacity-100 transition-opacity"></i>
            </div>
            
            <h2 id="counterDisplay" class="text-8xl md:text-9xl font-extrabold counter-glow leading-none transition-all duration-500">0</h2>
            
            <div class="flex flex-col items-center gap-3">
                <div class="flex flex-col items-center">
                    <p id="targetDisplay" class="text-slate-400 font-medium text-sm">Target: 1000</p>
                    <div id="progressBar" class="w-32 h-1 bg-slate-800 rounded-full overflow-hidden mt-1">
                        <div id="progressFill" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="text-slate-500 text-[10px] uppercase tracking-widest animate-pulse mt-4">
                    Tap anywhere to count
                </div>
            </div>
        </div>
    </main>

    <!-- Shortcut Instruction Modal -->
    <div id="shortcutModal" class="modal-base hidden">
        <div class="bg-slate-900 w-full max-w-sm rounded-3xl p-8 border border-primary-fade shadow-2xl relative">
            <button id="closeShortcut" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            
            <div class="w-16 h-16 bg-primary-fade rounded-2xl flex items-center justify-center mx-auto mb-6 text-primary">
                <i data-lucide="smartphone" class="w-8 h-8"></i>
            </div>
            
            <h3 class="text-xl font-bold text-center mb-2">Add to Home Screen</h3>
            <p class="text-slate-400 text-sm text-center mb-6">Access your Tasbeeh counter instantly from your phone's home screen.</p>
            
            <div id="iosInstructions" class="space-y-4 hidden">
                <div class="flex items-start gap-4 bg-white/5 p-4 rounded-2xl border border-white/5">
                    <div class="bg-blue-500/20 p-2 rounded-lg text-blue-400"><i data-lucide="share" class="w-5 h-5"></i></div>
                    <p class="text-sm">Tap the <span class="font-bold text-white">Share</span> button in Safari's toolbar.</p>
                </div>
                <div class="flex items-start gap-4 bg-white/5 p-4 rounded-2xl border border-white/5">
                    <div class="bg-green-500/20 p-2 rounded-lg text-green-400"><i data-lucide="plus-square" class="w-5 h-5"></i></div>
                    <p class="text-sm">Scroll down and select <span class="font-bold text-white">"Add to Home Screen"</span>.</p>
                </div>
            </div>

            <div id="androidInstructions" class="space-y-4 hidden">
                <div class="flex items-start gap-4 bg-white/5 p-4 rounded-2xl border border-white/5">
                    <div class="bg-slate-500/20 p-2 rounded-lg text-slate-400"><i data-lucide="more-vertical" class="w-5 h-5"></i></div>
                    <p class="text-sm">Tap the <span class="font-bold text-white">Menu</span> (three dots) in Chrome.</p>
                </div>
                <div class="flex items-start gap-4 bg-white/5 p-4 rounded-2xl border border-white/5">
                    <div class="bg-primary-fade p-2 rounded-lg text-primary"><i data-lucide="download" class="w-5 h-5"></i></div>
                    <p class="text-sm">Tap <span class="font-bold text-white">"Install App"</span> or <span class="font-bold text-white">"Add to Home screen"</span>.</p>
                </div>
            </div>

            <button id="gotItBtn" class="w-full bg-primary text-slate-950 font-bold py-4 rounded-xl mt-6 hover:opacity-90 transition-all">Got it!</button>
        </div>
    </div>

    <!-- Tutorial Overlay -->
    <div id="tutorialOverlay" class="modal-base hidden flex-col">
        <div class="max-w-xs w-full text-center">
            <div id="tutorialIcon" class="w-16 h-16 bg-primary-fade rounded-full flex items-center justify-center mx-auto mb-6 text-primary">
                <i data-lucide="info" class="w-8 h-8"></i>
            </div>
            <h3 id="tutorialTitle" class="text-2xl font-bold mb-4">Welcome</h3>
            <div id="tutorialTextContainer" class="min-h-[80px]">
                <p id="tutorialText" class="text-slate-400 mb-8 leading-relaxed">Let's walk through how to use your new Tasbeeh counter.</p>
            </div>
            <button id="tutorialNext" class="w-full bg-primary hover:opacity-90 py-4 rounded-2xl font-bold transition-all text-slate-950">Next</button>
            <button id="tutorialSkip" class="mt-4 text-slate-500 text-sm hover:text-white transition-colors">Skip Tutorial</button>
        </div>
    </div>

    <!-- Main Modal Overlay (Presets/History/Settings) -->
    <div id="modalOverlay" class="modal-base hidden items-end sm:items-center">
        <div class="bg-slate-900 w-full max-w-md rounded-3xl p-6 shadow-2xl border border-white/10 mb-0 sm:mb-0">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-xl font-bold">Presets</h3>
                <div class="flex gap-2">
                    <button id="editPresetsBtn" class="p-2 bg-white/5 rounded-full text-slate-400 hover:text-white transition-colors">
                        <i data-lucide="settings-2" class="w-5 h-5"></i>
                    </button>
                    <button id="closeModal" class="p-2 bg-white/5 rounded-full text-slate-400 hover:text-white transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div id="modalContent" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <!-- Edit Tasbeeh Modal -->
    <div id="editTasbeehModal" class="modal-base hidden">
        <div class="bg-slate-900 w-full max-sm rounded-3xl p-8 border border-primary-fade shadow-2xl">
            <h3 id="editTasbeehTitle" class="text-2xl font-bold text-center mb-2 text-primary">Tasbeeh Details</h3>
            <p id="editTasbeehSubtitle" class="text-slate-400 text-sm text-center mb-6">Set your name and target.</p>
            <input type="text" id="tasbeehNameInput" placeholder="e.g. SubhanAllah" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-4 text-white focus:border-primary outline-none transition-all text-center mb-4">
            <div class="mb-4">
                <label class="text-[10px] text-slate-500 uppercase tracking-widest block mb-2 text-center">Set Target</label>
                <input type="number" id="tasbeehTargetInput" placeholder="1000" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-primary outline-none transition-all text-center">
            </div>
            <button id="saveTasbeehBtn" class="w-full bg-primary hover:opacity-90 text-slate-950 font-bold py-4 rounded-xl transition-all">Update Counter</button>
        </div>
    </div>

    <!-- Name Entry Modal -->
    <div id="nameModal" class="modal-base hidden">
        <div class="bg-slate-900 w-full max-w-xs rounded-3xl p-6 border border-primary-fade shadow-2xl">
            <h3 class="text-xl font-bold text-center mb-2 text-primary">Tasbeeh Tag</h3>
            <p class="text-slate-400 text-xs text-center mb-4">Enter the person's name.</p>
            <input type="text" id="nameInput" placeholder="Enter name" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-primary outline-none transition-all text-center mb-4">
            <button id="saveNameBtn" class="w-full bg-primary hover:opacity-90 text-slate-950 font-bold py-3 rounded-xl transition-all">Save & Finish</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal-base hidden">
        <div class="bg-slate-900 w-full max-w-xs rounded-3xl p-5 border border-white/10 text-center shadow-2xl">
            <h3 id="confirmTitle" class="text-base font-bold mb-1 text-white">Reset Counter?</h3>
            <p id="confirmText" class="text-slate-400 text-xs mb-4">This action cannot be undone.</p>
            <div class="flex gap-2">
                <button id="confirmCancel" class="flex-1 bg-white/5 hover:bg-white/10 py-2 rounded-xl transition-all text-white font-medium text-sm">Cancel</button>
                <button id="confirmAction" class="flex-1 bg-red-600 hover:bg-red-500 py-2 rounded-xl transition-all text-white font-bold text-sm">Reset</button>
            </div>
        </div>
    </div>

    <div id="vibrationFlash" class="fixed inset-0 bg-primary-fade pointer-events-none opacity-0 transition-opacity duration-150 z-50"></div>

    <script>
        // --- FIREWORKS LOGIC ---
        const canvas = document.getElementById('fireworksCanvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.velocity = { x: (Math.random()-0.5)*12, y: (Math.random()-0.5)*12 };
                this.alpha = 1;
            }
            update() { this.x += this.velocity.x; this.y += this.velocity.y; this.velocity.y += 0.2; this.alpha -= 0.012; }
            draw() { ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, 2.5, 0, Math.PI*2); ctx.fill(); }
        }

        function triggerFireworks() {
            const rect = document.getElementById('counterDisplay').getBoundingClientRect();
            const cx = rect.left + rect.width/2; const cy = rect.top + rect.height/2;
            const color = getComputedStyle(document.body).getPropertyValue('--primary-hex');
            for(let i=0; i<60; i++) particles.push(new Particle(cx, cy, color));
        }

        function animateFireworks() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            particles = particles.filter(p => p.alpha > 0);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateFireworks);
        }
        animateFireworks();

        // State
        const DEFAULT_PRESETS = [
            { label: "Ya Allah", target: 1000 },
            { label: "Ya Mohammed", target: 1000 },
            { label: "Ya Ali", target: 1000 },
            { label: "Ya Fatema", target: 1000 },
            { label: "Ya Hasan", target: 1000 },
            { label: "Ya Hussain", target: 1000 },
            { label: "Astagfirullah", target: 1000 }
        ];

        const THEMES = [
            { id: 'emerald', label: 'Emerald', class: 'theme-emerald' },
            { id: 'ruby', label: 'Ruby', class: 'theme-ruby' },
            { id: 'sapphire', label: 'Sapphire', class: 'theme-sapphire' },
            { id: 'amber', label: 'Amber', class: 'theme-amber' },
            { id: 'rose', label: 'Rose', class: 'theme-rose' }
        ];

        let state = {
            count: 0,
            target: 1000,
            milestone: 100, // Celebration Interval
            label: "Ya Allah",
            userName: "", 
            history: [],
            presets: [...DEFAULT_PRESETS],
            currentTheme: 'emerald',
            isEditingPresets: false,
            tutorialStep: 0,
            tutorialCompleted: false,
            selectedHistoryIds: []
        };

        // UI Helpers
        const counterDisplay = document.getElementById('counterDisplay');
        const tapArea = document.getElementById('tapArea');
        const labelDisplay = document.getElementById('labelDisplay');
        const targetDisplay = document.getElementById('targetDisplay');
        const progressFill = document.getElementById('progressFill');
        const flash = document.getElementById('vibrationFlash');
        const userBadge = document.getElementById('userBadge');
        const badgeName = document.getElementById('badgeName');
        const labelContainer = document.getElementById('labelContainer');
        const helpBtn = document.getElementById('helpBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const appBody = document.getElementById('appBody');
        const shortcutBtn = document.getElementById('shortcutBtn');
        
        // Modals
        const mainModal = document.getElementById('modalOverlay');
        const nameModal = document.getElementById('nameModal');
        const confirmModal = document.getElementById('confirmModal');
        const editTasbeehModal = document.getElementById('editTasbeehModal');
        const tutorialOverlay = document.getElementById('tutorialOverlay');
        const shortcutModal = document.getElementById('shortcutModal');

        function saveData() {
            localStorage.setItem('tasbeeh_state_v5', JSON.stringify({
                count: state.count,
                target: state.target,
                milestone: state.milestone,
                label: state.label,
                userName: state.userName,
                presets: state.presets,
                currentTheme: state.currentTheme,
                tutorialCompleted: state.tutorialCompleted
            }));
            localStorage.setItem('tasbeeh_history', JSON.stringify(state.history));
        }

        function applyTheme(themeId) {
            state.currentTheme = themeId;
            THEMES.forEach(t => appBody.classList.remove(t.class));
            const theme = THEMES.find(t => t.id === themeId);
            appBody.classList.add(theme.class);
            saveData();
        }

        function loadData() {
            const savedState = localStorage.getItem('tasbeeh_state_v5');
            const savedHistory = localStorage.getItem('tasbeeh_history');
            
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.count = parsed.count || 0;
                state.target = parsed.target || 1000;
                state.milestone = parsed.milestone || 100;
                state.label = parsed.label || "Ya Allah";
                state.userName = parsed.userName || "";
                state.presets = parsed.presets || [...DEFAULT_PRESETS];
                state.currentTheme = parsed.currentTheme || 'emerald';
                state.tutorialCompleted = parsed.tutorialCompleted || false;
                applyTheme(state.currentTheme);
            }

            if (savedHistory) {
                state.history = JSON.parse(savedHistory);
            }

            if (!state.tutorialCompleted) {
                setTimeout(() => startTutorial(), 800);
            }
        }

        function updateUI() {
            counterDisplay.innerText = state.count;
            labelDisplay.innerText = state.label;
            
            if (state.userName) {
                badgeName.innerText = state.userName;
                userBadge.classList.remove('hidden');
            } else {
                userBadge.classList.add('hidden');
            }

            const percent = Math.min((state.count / state.target) * 100, 100);
            progressFill.style.width = `${percent}%`;
            targetDisplay.innerText = `Target: ${state.target}`;
        }

        function triggerHaptic() {
            if (navigator.vibrate) navigator.vibrate(50);
            flash.style.opacity = '1';
            setTimeout(() => flash.style.opacity = '0', 80);
        }

        function anyModalOpen() {
            return !mainModal.classList.contains('hidden') || 
                   !nameModal.classList.contains('hidden') || 
                   !confirmModal.classList.contains('hidden') || 
                   !editTasbeehModal.classList.contains('hidden') || 
                   !shortcutModal.classList.contains('hidden') ||
                   !tutorialOverlay.classList.contains('hidden');
        }

        function increment(e) {
            if (anyModalOpen()) return;
            if (e) { e.preventDefault(); e.stopPropagation(); }
            state.count++;
            
            // FIREWORKS TRIGGER: On milestone interval OR reaching target
            if (state.count % state.milestone === 0 || state.count === state.target) {
                triggerFireworks();
                triggerHaptic();
            } else if(navigator.vibrate) {
                navigator.vibrate(40);
            }

            flash.style.opacity = '1';
            setTimeout(() => flash.style.opacity = '0', 80);
            
            updateUI();
            saveData();
        }

        const tutorialSteps = [
            { title: "Tap to Count", text: "The entire screen is your button. Tap anywhere in the center to increment the count.", icon: "hand-tap", highlight: "tapArea" },
            { title: "Settings & Colors", text: "Customize colors and update celebration milestones here.", icon: "settings", highlight: "settingsBtn" },
            { title: "Add Shortcut", text: "Save this counter as an app on your phone for quick, full-screen access anytime.", icon: "plus-circle", highlight: "shortcutBtn" },
            { title: "Change Label", text: "Tap the label above the counter to set a custom name and target.", icon: "pencil", highlight: "labelContainer" },
            { title: "Save History", text: "Tap 'Save' to tag your session with a name and store it in your history.", icon: "save", highlight: "finishBtn" },
            { title: "Share to WhatsApp", text: "View your history and share your progress to WhatsApp. You can share individual sessions or consolidate multiple ones!", icon: "share-2", highlight: "historyBtn" }
        ];

        function startTutorial() {
            state.tutorialStep = 0;
            tutorialOverlay.classList.remove('hidden');
            showTutorialStep();
        }

        function showTutorialStep() {
            const step = tutorialSteps[state.tutorialStep];
            document.getElementById('tutorialTitle').innerText = step.title;
            document.getElementById('tutorialText').innerText = step.text;
            document.getElementById('tutorialIcon').innerHTML = `<i data-lucide="${step.icon}" class="w-8 h-8"></i>`;
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
            const targetEl = document.getElementById(step.highlight);
            if (targetEl) targetEl.classList.add('tutorial-highlight');
            document.getElementById('tutorialNext').innerText = state.tutorialStep === tutorialSteps.length - 1 ? "Get Started" : "Next";
            lucide.createIcons();
        }

        document.getElementById('tutorialNext').onclick = () => {
            if (state.tutorialStep < tutorialSteps.length - 1) {
                state.tutorialStep++;
                showTutorialStep();
            } else {
                closeTutorial(true);
            }
        };

        document.getElementById('tutorialSkip').onclick = () => closeTutorial(true);
        helpBtn.onclick = (e) => { e.stopPropagation(); startTutorial(); };

        function closeTutorial(markAsCompleted = false) {
            tutorialOverlay.classList.add('hidden');
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
            if (markAsCompleted) {
                state.tutorialCompleted = true;
                saveData();
            }
        }

        shortcutBtn.onclick = (e) => {
            e.stopPropagation();
            const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            document.getElementById('iosInstructions').classList.toggle('hidden', !isiOS);
            document.getElementById('androidInstructions').classList.toggle('hidden', isiOS);
            shortcutModal.classList.remove('hidden');
            lucide.createIcons();
        };
        document.getElementById('closeShortcut').onclick = () => shortcutModal.classList.add('hidden');
        document.getElementById('gotItBtn').onclick = () => shortcutModal.classList.add('hidden');

        function openConfirm(title, text, actionLabel, onConfirm) {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmText').innerText = text;
            const confirmBtn = document.getElementById('confirmAction');
            confirmBtn.innerText = actionLabel;
            confirmBtn.onclick = () => { onConfirm(); confirmModal.classList.add('hidden'); };
            confirmModal.classList.remove('hidden');
        }

        function saveSession() {
            const session = {
                label: state.label,
                count: state.count,
                target: state.target,
                userName: state.userName || "Guest",
                date: new Date().toLocaleString(),
                id: Date.now()
            };
            state.history.unshift(session);
            state.count = 0;
            state.userName = ""; 
            updateUI();
            saveData();
            showToast(`Saved for ${session.userName}`);
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-12 left-1/2 -translate-x-1/2 bg-primary text-slate-950 px-6 py-2 rounded-full font-bold shadow-lg z-[100] transition-colors duration-500';
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        function openModal(type) {
            mainModal.classList.remove('hidden');
            const content = document.getElementById('modalContent');
            const editBtn = document.getElementById('editPresetsBtn');
            content.innerHTML = '';
            
            if (type === 'presets') {
                document.getElementById('modalTitle').innerText = state.isEditingPresets ? "Edit Presets" : "Select Tasbeeh";
                editBtn.classList.remove('hidden');
                
                if (state.isEditingPresets) {
                    editBtn.innerHTML = '<i data-lucide="check" class="w-5 h-5"></i>';
                    editBtn.classList.add('bg-primary', 'text-slate-950');
                    editBtn.classList.remove('bg-white/5', 'text-slate-400');
                } else {
                    editBtn.innerHTML = '<i data-lucide="settings-2" class="w-5 h-5"></i>';
                    editBtn.classList.remove('bg-primary', 'text-slate-950');
                    editBtn.classList.add('bg-white/5', 'text-slate-400');
                }

                if (!state.isEditingPresets) {
                    const customBtn = document.createElement('button');
                    customBtn.className = 'w-full text-left p-4 bg-primary-fade border border-primary-fade rounded-xl flex justify-between items-center mb-4';
                    customBtn.innerHTML = `<div><div class="font-bold text-primary">Custom Tasbeeh</div><div class="text-xs text-primary/60">One-time session</div></div><i data-lucide="plus" class="w-4 h-4 text-primary"></i>`;
                    customBtn.onclick = () => { mainModal.classList.add('hidden'); openEditTasbeeh('custom'); };
                    content.appendChild(customBtn);
                } else {
                    const addBtn = document.createElement('button');
                    addBtn.className = 'w-full text-center p-3 border border-dashed border-primary-fade text-primary rounded-xl mb-4 text-xs font-bold hover:bg-primary-fade transition-colors';
                    addBtn.innerText = "+ Add New Preset";
                    addBtn.onclick = () => { mainModal.classList.add('hidden'); openEditTasbeeh('preset'); };
                    content.appendChild(addBtn);
                }

                state.presets.forEach((p, idx) => {
                    const btn = document.createElement('div');
                    btn.className = 'preset-item w-full flex gap-2 items-center';
                    const inner = document.createElement('button');
                    inner.className = `flex-grow text-left p-4 glass rounded-xl flex justify-between items-center ${state.isEditingPresets ? 'opacity-50 cursor-default' : 'hover:bg-white/10'}`;
                    inner.innerHTML = `<div><div class="font-bold">${p.label}</div><div class="text-xs text-slate-400">Target: ${p.target}</div></div>`;
                    if (!state.isEditingPresets) {
                        inner.onclick = () => {
                            state.label = p.label; state.target = p.target; state.count = 0; state.userName = ""; 
                            updateUI(); saveData(); mainModal.classList.add('hidden');
                        };
                    }
                    btn.appendChild(inner);
                    if (state.isEditingPresets) {
                        const delBtn = document.createElement('button');
                        delBtn.className = 'p-4 bg-red-500/10 text-red-400 rounded-xl hover:bg-red-500/20 transition-colors';
                        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
                        delBtn.onclick = () => { state.presets.splice(idx, 1); saveData(); openModal('presets'); };
                        btn.appendChild(delBtn);
                    } else { inner.innerHTML += '<i data-lucide="chevron-right" class="w-4 h-4"></i>'; }
                    content.appendChild(btn);
                });
            } else if (type === 'settings') {
                document.getElementById('modalTitle').innerText = "App Settings";
                editBtn.classList.add('hidden');
                
                // Milestone Section
                const milestoneDiv = document.createElement('div');
                milestoneDiv.className = 'mb-6 p-4 glass rounded-2xl border-primary-fade border';
                milestoneDiv.innerHTML = `
                    <div class="flex items-center gap-2 mb-3 text-primary font-bold text-sm">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> Celebration Milestone
                    </div>
                    <p class="text-[10px] text-slate-400 mb-3">Fireworks will trigger every X counts.</p>
                    <div class="flex gap-2">
                        <input type="number" id="milestoneInput" value="${state.milestone}" class="flex-grow bg-slate-950/50 border border-white/10 rounded-xl px-4 py-2 text-white outline-none focus:border-primary transition-all">
                        <button id="saveMilestone" class="bg-primary text-slate-950 px-4 py-2 rounded-xl font-bold text-xs">Update</button>
                    </div>
                `;
                content.appendChild(milestoneDiv);

                // Theme Section
                const themeTitle = document.createElement('div');
                themeTitle.className = 'px-1 text-[10px] text-slate-500 uppercase tracking-widest mb-3';
                themeTitle.innerText = "Color Theme";
                content.appendChild(themeTitle);

                THEMES.forEach(t => {
                    const btn = document.createElement('button');
                    const isActive = state.currentTheme === t.id;
                    btn.className = `w-full p-4 glass rounded-xl flex items-center justify-between mb-2 ${isActive ? 'border-primary border-2' : ''}`;
                    btn.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-6 h-6 rounded-full ${t.class} bg-primary"></div>
                            <span class="font-bold">${t.label}</span>
                        </div>
                        ${isActive ? '<i data-lucide="check" class="w-4 h-4 text-primary"></i>' : ''}
                    `;
                    btn.onclick = () => { applyTheme(t.id); openModal('settings'); };
                    content.appendChild(btn);
                });

                // Attach Milestone logic
                setTimeout(() => {
                    document.getElementById('saveMilestone').onclick = () => {
                        const val = parseInt(document.getElementById('milestoneInput').value);
                        if (val > 0) {
                            state.milestone = val;
                            saveData();
                            showToast(`Milestone updated to ${val}`);
                        }
                    };
                }, 0);
            } else {
                document.getElementById('modalTitle').innerText = "History";
                editBtn.classList.add('hidden');
                if (state.history.length === 0) {
                    content.innerHTML = '<p class="text-center text-slate-500 py-8 text-sm">No saved sessions.</p>';
                } else {
                    state.history.forEach(h => {
                        const div = document.createElement('div');
                        div.className = 'p-4 glass rounded-xl mb-2 flex flex-col gap-2';
                        const isSelected = state.selectedHistoryIds.includes(h.id);
                        div.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2 flex-grow">
                                    <input type="checkbox" class="history-checkbox" data-id="${h.id}" ${isSelected ? 'checked' : ''} style="cursor: pointer;">
                                    <div>
                                        <div class="font-bold text-sm">${h.label}</div>
                                        <div class="text-[10px] text-primary font-bold uppercase tracking-wide">${h.userName || 'Guest'}</div>
                                        <div class="text-[10px] text-slate-500">${h.date}</div>
                                    </div>
                                </div>
                                <div class="text-xl font-black text-primary">${h.count}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="resumeItem(${h.id})" class="flex-grow bg-primary-fade text-primary py-2 rounded-lg text-xs font-bold">Continue</button>
                                <button onclick="shareHistoryItem(${h.id})" class="px-3 bg-green-500/10 text-green-400 py-2 rounded-lg hover:bg-green-500/20 transition-colors" title="Share to WhatsApp"><i data-lucide="share-2" class="w-4 h-4"></i></button>
                                <button onclick="deleteItem(${h.id})" class="px-3 bg-red-500/10 text-red-400 py-2 rounded-lg hover:bg-red-500/20 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        content.appendChild(div);
                    });
                    
                    // Add consolidate button if items exist
                    if (state.history.length > 0) {
                        const consolidateDiv = document.createElement('div');
                        consolidateDiv.className = 'mt-6 pt-4 border-t border-white/10';
                        consolidateDiv.innerHTML = `
                            <button id="consolidateBtn" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-3 rounded-xl transition-all text-sm flex items-center justify-center gap-2">
                                <i data-lucide="layers-2" class="w-4 h-4"></i>
                                Consolidate & Share
                            </button>
                            <p class="text-[10px] text-slate-500 text-center mt-2">Select items to consolidate by tasbeeh type</p>
                        `;
                        content.appendChild(consolidateDiv);
                        
                        // Attach checkbox listeners
                        setTimeout(() => {
                            document.querySelectorAll('.history-checkbox').forEach(cb => {
                                cb.onchange = (e) => {
                                    const id = parseInt(e.target.dataset.id);
                                    if (e.target.checked) {
                                        if (!state.selectedHistoryIds.includes(id)) state.selectedHistoryIds.push(id);
                                    } else {
                                        state.selectedHistoryIds = state.selectedHistoryIds.filter(sid => sid !== id);
                                    }
                                };
                            });
                            
                            document.getElementById('consolidateBtn').onclick = () => {
                                if (state.selectedHistoryIds.length === 0) {
                                    showToast('Select items to consolidate');
                                    return;
                                }
                                consolidateAndShare();
                            };
                        }, 0);
                    }
                }
            }
            lucide.createIcons();
        }

        let editMode = 'custom'; 
        function openEditTasbeeh(mode = 'custom') {
            editMode = mode;
            document.getElementById('editTasbeehTitle').innerText = mode === 'custom' ? "Custom Tasbeeh" : "Add New Preset";
            document.getElementById('tasbeehNameInput').value = mode === 'custom' ? state.label : "";
            document.getElementById('tasbeehTargetInput').value = mode === 'custom' ? state.target : 1000;
            editTasbeehModal.classList.remove('hidden');
        }

        window.resumeItem = (id) => {
            const item = state.history.find(h => h.id === id);
            if (item) {
                state.label = item.label; state.count = item.count; state.target = item.target; state.userName = item.userName || ""; 
                state.history = state.history.filter(h => h.id !== id);
                updateUI(); saveData(); mainModal.classList.add('hidden');
            }
        };

        window.deleteItem = (id) => { state.history = state.history.filter(h => h.id !== id); saveData(); openModal('history'); };

        function shareToWhatsApp(label, count, target, userName) {
            const progress = Math.round((count / target) * 100);
            const message = `I performed *${label}* Tasbeeh!\n\nðŸ“Š Progress: ${count}/${target}\nðŸŽ¯ ${progress}% complete${userName && userName !== 'Guest' ? `\nðŸ‘¤ ${userName}` : ''}`;
            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        window.shareHistoryItem = (id) => {
            const item = state.history.find(h => h.id === id);
            if (item) shareToWhatsApp(item.label, item.count, item.target, item.userName);
        };

        function consolidateAndShare() {
            if (state.selectedHistoryIds.length === 0) return;
            
            // Group by label and sum counts
            const grouped = {};
            state.selectedHistoryIds.forEach(id => {
                const item = state.history.find(h => h.id === id);
                if (item) {
                    if (!grouped[item.label]) {
                        grouped[item.label] = { count: 0, target: item.target, userName: item.userName };
                    }
                    grouped[item.label].count += item.count;
                }
            });

            // Build consolidated message
            let message = "ðŸ“Š *Consolidated Tasbeeh Progress*\n\n";
            let totalCount = 0;
            Object.entries(grouped).forEach(([label, data]) => {
                const progress = Math.round((data.count / data.target) * 100);
                message += `âœ¨ *${label}*\n   ${data.count}/${data.target} (${progress}%)\n\n`;
                totalCount += data.count;
            });
            message += `ðŸŽ¯ *Total: ${totalCount} Tasbeeh*`;
            
            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            
            // Clear selection and close modal
            state.selectedHistoryIds = [];
            mainModal.classList.add('hidden');
            showToast('Shared consolidated progress!');
        }

        document.getElementById('saveNameBtn').onclick = () => {
            const input = document.getElementById('nameInput');
            const name = input.value.trim() || "Guest";
            state.userName = name;
            nameModal.classList.add('hidden');
            updateUI(); saveData();
            if (state.count > 0) saveSession();
        };

        document.getElementById('saveTasbeehBtn').onclick = () => {
            const nameIn = document.getElementById('tasbeehNameInput');
            const targetIn = document.getElementById('tasbeehTargetInput');
            const label = nameIn.value.trim() || "Tasbeeh";
            const target = parseInt(targetIn.value) || 1000;

            if (editMode === 'custom') {
                state.label = label; state.target = target; state.count = 0; state.userName = ""; updateUI();
            } else {
                state.presets.push({ label, target });
                setTimeout(() => openModal('presets'), 100);
            }
            editTasbeehModal.classList.add('hidden');
            saveData();
        };

        document.getElementById('editPresetsBtn').onclick = () => {
            state.isEditingPresets = !state.isEditingPresets;
            openModal('presets');
        };

        document.getElementById('resetBtn').onclick = (e) => {
            e.stopPropagation();
            openConfirm("Reset Counter?", "Clear current progress?", "Reset", () => {
                state.count = 0; state.userName = ""; updateUI(); saveData();
            });
        };

        userBadge.onclick = () => { document.getElementById('nameInput').value = state.userName; nameModal.classList.remove('hidden'); };
        labelContainer.onclick = (e) => { e.stopPropagation(); openEditTasbeeh('custom'); };
        document.getElementById('finishBtn').onclick = () => {
            if (state.count === 0) return;
            if (!state.userName) { document.getElementById('nameInput').value = ""; nameModal.classList.remove('hidden'); return; }
            saveSession();
        };
        document.getElementById('presetBtn').onclick = () => { state.isEditingPresets = false; openModal('presets'); };
        document.getElementById('historyBtn').onclick = () => openModal('history');
        settingsBtn.onclick = () => openModal('settings');
        document.getElementById('closeModal').onclick = () => mainModal.classList.add('hidden');
        document.getElementById('confirmCancel').onclick = () => confirmModal.classList.add('hidden');
        
        tapArea.onpointerdown = increment;

        loadData();
        updateUI();
        lucide.createIcons();
    </script>
</body>
</html>