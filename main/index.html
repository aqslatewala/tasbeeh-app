<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abdulqadir Slatewala Tasbeeh Counter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Dynamic Theme Classes */
        .theme-emerald { --primary-rgb: 16, 185, 129; --primary-hex: #10b981; }
        .theme-ruby { --primary-rgb: 225, 29, 72; --primary-hex: #e11d48; }
        .theme-sapphire { --primary-rgb: 37, 99, 235; --primary-hex: #2563eb; }
        .theme-amber { --primary-rgb: 245, 158, 11; --primary-hex: #f59e0b; }
        .theme-rose { --primary-rgb: 219, 39, 119; --primary-hex: #db2677; }

        .text-primary { color: var(--primary-hex); }
        .bg-primary { background-color: var(--primary-hex); }
        .border-primary { border-color: var(--primary-hex); }
        .bg-primary-fade { background-color: rgba(var(--primary-rgb), 0.1); }
        .border-primary-fade { border-color: rgba(var(--primary-rgb), 0.2); }

        /* Background Effects */
        .bg-gradient-dynamic {
            background: linear-gradient(to bottom, #0f172a, #020617);
            position: relative;
            overflow: hidden;
        }

        .dynamic-glow {
            position: absolute;
            width: 80vw;
            height: 80vw;
            background: radial-gradient(circle, rgba(var(--primary-rgb), 0.15) 0%, rgba(var(--primary-rgb), 0) 70%);
            top: -10%;
            right: -10%;
            border-radius: 50%;
            filter: blur(60px);
            transition: background 1s ease;
            pointer-events: none;
            z-index: 0;
            animation: drift 20s infinite alternate ease-in-out;
        }

        .bg-grid {
            position: absolute;
            inset: 0;
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes drift {
            from { transform: translate(0, 0); }
            to { transform: translate(-10%, 10%); }
        }

        .counter-glow {
            text-shadow: 0 0 20px rgba(var(--primary-rgb), 0.3);
        }

        .tap-active:active {
            transform: scale(0.96);
            transition: transform 0.05s;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }

        #modalContent::-webkit-scrollbar {
            display: none;
        }

        .preset-item {
            transition: all 0.2s ease;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .tutorial-highlight::after {
            content: '';
            position: absolute;
            inset: -4px;
            border: 2px solid var(--primary-hex);
            border-radius: inherit;
            animation: pulse-ring 1.5s infinite;
        }
    </style>
</head>
<body id="appBody" class="bg-gradient-dynamic text-white min-h-screen overflow-hidden flex flex-col theme-emerald">
    
    <!-- Decorative Background Layers -->
    <div class="bg-grid"></div>
    <div class="dynamic-glow"></div>

    <!-- Header & Controls -->
    <header class="p-4 flex flex-col gap-4 z-10 bg-slate-950/40 backdrop-blur-md border-b border-white/5">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center transition-colors duration-500">
                    <i data-lucide="hash" class="w-5 h-5 text-slate-950"></i>
                </div>
                <h1 class="font-semibold text-lg tracking-tight">Tasbeeh Counter</h1>
            </div>
            <div class="flex items-center gap-2">
                <!-- Theme Switcher -->
                <button id="themeBtn" title="Change Color" class="p-2 text-slate-400 hover:text-primary transition-colors">
                    <i data-lucide="palette" class="w-5 h-5"></i>
                </button>
                <button id="helpBtn" title="Show Tutorial" class="p-2 text-slate-400 hover:text-primary transition-colors">
                    <i data-lucide="help-circle" class="w-5 h-5"></i>
                </button>
                <div id="userBadge" class="text-[10px] bg-primary-fade px-2 py-1 rounded-full text-primary font-bold hidden border border-primary-fade cursor-pointer transition-colors flex items-center gap-1">
                    <span id="badgeName"></span>
                    <i data-lucide="user-round-pen" class="w-3 h-3"></i>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="grid grid-cols-4 gap-2">
            <button id="resetBtn" class="glass p-2 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors">
                <i data-lucide="rotate-ccw" class="w-4 h-4 text-orange-400"></i>
                <span class="text-[10px] font-medium">Reset</span>
            </button>
            <button id="presetBtn" class="glass p-2 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors">
                <i data-lucide="list-music" class="w-4 h-4 text-blue-400"></i>
                <span class="text-[10px] font-medium">Presets</span>
            </button>
            <button id="historyBtn" class="glass p-2 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors">
                <i data-lucide="history" class="w-4 h-4 text-purple-400"></i>
                <span class="text-[10px] font-medium">History</span>
            </button>
            <button id="finishBtn" class="glass p-2 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors border-primary-fade">
                <i data-lucide="save" class="w-4 h-4 text-primary"></i>
                <span class="text-[10px] font-medium leading-tight">Save</span>
            </button>
        </div>
    </header>

    <!-- Main Interaction Area -->
    <main id="tapArea" class="flex-grow flex flex-col items-center justify-center relative no-select tap-active cursor-pointer p-4 z-10">
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-5">
            <div class="w-64 h-64 border-4 border-primary rounded-full transition-colors duration-500"></div>
        </div>

        <div class="text-center z-10 pointer-events-none flex flex-col items-center gap-2">
            <div id="labelContainer" class="pointer-events-auto cursor-pointer group flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full border border-white/5 hover:border-primary-fade transition-all">
                <span id="labelDisplay" class="text-primary text-sm font-semibold tracking-widest uppercase block transition-colors duration-500">Ya Allah</span>
                <i data-lucide="pencil" class="w-3 h-3 text-primary opacity-0 group-hover:opacity-100 transition-opacity"></i>
            </div>
            
            <h2 id="counterDisplay" class="text-8xl md:text-9xl font-extrabold counter-glow leading-none transition-all duration-500">0</h2>
            
            <div class="flex flex-col items-center gap-3">
                <div class="flex flex-col items-center">
                    <p id="targetDisplay" class="text-slate-400 font-medium text-sm">Target: 1000</p>
                    <div id="progressBar" class="w-32 h-1 bg-slate-800 rounded-full overflow-hidden mt-1">
                        <div id="progressFill" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="text-slate-500 text-[10px] uppercase tracking-widest animate-pulse mt-4">
                    Tap anywhere to count
                </div>
            </div>
        </div>
    </main>

    <!-- Tutorial Overlay -->
    <div id="tutorialOverlay" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-6 backdrop-blur-md">
        <div class="max-w-xs w-full text-center">
            <div id="tutorialIcon" class="w-16 h-16 bg-primary-fade rounded-full flex items-center justify-center mx-auto mb-6 text-primary">
                <i data-lucide="info" class="w-8 h-8"></i>
            </div>
            <h3 id="tutorialTitle" class="text-2xl font-bold mb-4">Welcome</h3>
            <div id="tutorialTextContainer" class="min-h-[80px]">
                <p id="tutorialText" class="text-slate-400 mb-8 leading-relaxed">Let's walk through how to use your new Tasbeeh counter.</p>
            </div>
            <button id="tutorialNext" class="w-full bg-primary hover:opacity-90 py-4 rounded-2xl font-bold transition-all text-slate-950">Next</button>
            <button id="tutorialSkip" class="mt-4 text-slate-500 text-sm hover:text-white transition-colors">Skip Tutorial</button>
        </div>
    </div>

    <!-- Main Modal Overlay -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-md rounded-3xl p-6 shadow-2xl border border-white/10">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-xl font-bold">Presets</h3>
                <div class="flex gap-2">
                    <button id="editPresetsBtn" class="p-2 bg-white/5 rounded-full text-slate-400 hover:text-white transition-colors">
                        <i data-lucide="settings-2" class="w-5 h-5"></i>
                    </button>
                    <button id="closeModal" class="p-2 bg-white/5 rounded-full text-slate-400 hover:text-white transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div id="modalContent" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <!-- Edit Tasbeeh Modal -->
    <div id="editTasbeehModal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[60] hidden flex items-center justify-center p-6">
        <div class="bg-slate-900 w-full max-w-sm rounded-3xl p-8 border border-primary-fade shadow-2xl">
            <h3 id="editTasbeehTitle" class="text-2xl font-bold text-center mb-2 text-primary">Tasbeeh Details</h3>
            <p id="editTasbeehSubtitle" class="text-slate-400 text-sm text-center mb-6">Set your name and target.</p>
            <input type="text" id="tasbeehNameInput" placeholder="e.g. SubhanAllah" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-4 text-white focus:border-primary outline-none transition-all text-center mb-4">
            <div class="mb-4">
                <label class="text-[10px] text-slate-500 uppercase tracking-widest block mb-2 text-center">Set Target</label>
                <input type="number" id="tasbeehTargetInput" placeholder="1000" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-primary outline-none transition-all text-center">
            </div>
            <button id="saveTasbeehBtn" class="w-full bg-primary hover:opacity-90 text-slate-950 font-bold py-4 rounded-xl transition-all">Update Counter</button>
        </div>
    </div>

    <!-- Name Entry Modal -->
    <div id="nameModal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[60] hidden flex items-center justify-center p-6">
        <div class="bg-slate-900 w-full max-w-sm rounded-3xl p-8 border border-primary-fade shadow-2xl">
            <h3 class="text-2xl font-bold text-center mb-2 text-primary">Tasbeeh Tag</h3>
            <p class="text-slate-400 text-sm text-center mb-6">Enter the name of the person performing this Tasbeeh.</p>
            <input type="text" id="nameInput" placeholder="Enter name" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-4 text-white focus:border-primary outline-none transition-all text-center mb-4">
            <button id="saveNameBtn" class="w-full bg-primary hover:opacity-90 text-slate-950 font-bold py-4 rounded-xl transition-all">Save & Finish</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-70 hidden flex items-center justify-center p-6">
        <div class="bg-slate-900 w-full max-w-xs rounded-3xl p-6 border border-white/10 text-center">
            <h3 id="confirmTitle" class="text-lg font-bold mb-2">Reset Counter?</h3>
            <p id="confirmText" class="text-slate-400 text-sm mb-6">This action cannot be undone.</p>
            <div class="flex gap-3">
                <button id="confirmCancel" class="flex-1 bg-white/5 hover:bg-white/10 py-3 rounded-xl transition-all">Cancel</button>
                <button id="confirmAction" class="flex-1 bg-red-600 hover:bg-red-500 py-3 rounded-xl transition-all">Reset</button>
            </div>
        </div>
    </div>

    <div id="vibrationFlash" class="fixed inset-0 bg-primary-fade pointer-events-none opacity-0 transition-opacity duration-150"></div>

    <script>
        // State
        const DEFAULT_PRESETS = [
            { label: "Ya Allah", target: 1000 },
            { label: "Ya Mohammed", target: 1000 },
            { label: "Ya Ali", target: 1000 },
            { label: "Ya Fatema", target: 1000 },
            { label: "Ya Hasan", target: 1000 },
            { label: "Ya Hussain", target: 1000 },
            { label: "Astagfirullah", target: 1000 }
        ];

        const THEMES = [
            { id: 'emerald', label: 'Emerald', class: 'theme-emerald' },
            { id: 'ruby', label: 'Ruby', class: 'theme-ruby' },
            { id: 'sapphire', label: 'Sapphire', class: 'theme-sapphire' },
            { id: 'amber', label: 'Amber', class: 'theme-amber' },
            { id: 'rose', label: 'Rose', class: 'theme-rose' }
        ];

        let state = {
            count: 0,
            target: 1000,
            label: "Ya Allah",
            userName: "", 
            history: [],
            presets: [...DEFAULT_PRESETS],
            currentTheme: 'emerald',
            isEditingPresets: false,
            tutorialStep: 0,
            tutorialCompleted: false
        };

        // UI Helpers
        const counterDisplay = document.getElementById('counterDisplay');
        const tapArea = document.getElementById('tapArea');
        const labelDisplay = document.getElementById('labelDisplay');
        const targetDisplay = document.getElementById('targetDisplay');
        const progressFill = document.getElementById('progressFill');
        const flash = document.getElementById('vibrationFlash');
        const userBadge = document.getElementById('userBadge');
        const badgeName = document.getElementById('badgeName');
        const labelContainer = document.getElementById('labelContainer');
        const helpBtn = document.getElementById('helpBtn');
        const themeBtn = document.getElementById('themeBtn');
        const appBody = document.getElementById('appBody');
        
        // Modals
        const mainModal = document.getElementById('modalOverlay');
        const nameModal = document.getElementById('nameModal');
        const confirmModal = document.getElementById('confirmModal');
        const editTasbeehModal = document.getElementById('editTasbeehModal');
        const tutorialOverlay = document.getElementById('tutorialOverlay');

        function saveData() {
            localStorage.setItem('tasbeeh_state_v4', JSON.stringify({
                count: state.count,
                target: state.target,
                label: state.label,
                userName: state.userName,
                presets: state.presets,
                currentTheme: state.currentTheme,
                tutorialCompleted: state.tutorialCompleted
            }));
            localStorage.setItem('tasbeeh_history', JSON.stringify(state.history));
        }

        function applyTheme(themeId) {
            state.currentTheme = themeId;
            THEMES.forEach(t => appBody.classList.remove(t.class));
            const theme = THEMES.find(t => t.id === themeId);
            appBody.classList.add(theme.class);
            saveData();
        }

        function loadData() {
            const savedState = localStorage.getItem('tasbeeh_state_v4');
            const savedHistory = localStorage.getItem('tasbeeh_history');
            
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.count = parsed.count || 0;
                state.target = parsed.target || 1000;
                state.label = parsed.label || "Ya Allah";
                state.userName = parsed.userName || "";
                state.presets = parsed.presets || [...DEFAULT_PRESETS];
                state.currentTheme = parsed.currentTheme || 'emerald';
                state.tutorialCompleted = parsed.tutorialCompleted || false;
                applyTheme(state.currentTheme);
            }

            if (savedHistory) {
                state.history = JSON.parse(savedHistory);
            }

            if (!state.tutorialCompleted) {
                setTimeout(() => startTutorial(), 800);
            }
        }

        function updateUI() {
            counterDisplay.innerText = state.count;
            labelDisplay.innerText = state.label;
            
            if (state.userName) {
                badgeName.innerText = state.userName;
                userBadge.classList.remove('hidden');
            } else {
                userBadge.classList.add('hidden');
            }

            const percent = Math.min((state.count / state.target) * 100, 100);
            progressFill.style.width = `${percent}%`;
            targetDisplay.innerText = `Target: ${state.target}`;
        }

        function triggerHaptic() {
            if (navigator.vibrate) navigator.vibrate(50);
            flash.style.opacity = '1';
            setTimeout(() => flash.style.opacity = '0', 80);
        }

        function increment(e) {
            if (e) { e.preventDefault(); e.stopPropagation(); }
            state.count++;
            if (state.count % 100 === 0 || state.count === state.target) triggerHaptic();
            updateUI();
            saveData();
        }

        // Tutorial Steps
        const tutorialSteps = [
            {
                title: "Tap to Count",
                text: "The entire screen is your button. Tap anywhere in the center to increment the count.",
                icon: "hand-tap",
                highlight: "tapArea"
            },
            {
                title: "Personalize Color",
                text: "Tap the palette icon to choose a color that resonates with your heart.",
                icon: "palette",
                highlight: "themeBtn"
            },
            {
                title: "Change Label",
                text: "Tap the label above the counter to set a custom name and target for your current session.",
                icon: "pencil",
                highlight: "labelContainer"
            },
            {
                title: "Manage Presets",
                text: "Inside the Presets menu, tap Settings to add new custom recitations or delete old ones.",
                icon: "settings-2",
                highlight: "presetBtn"
            },
            {
                title: "Save History",
                text: "When you're done, tap 'Save' to tag your session with a name and store it in your history.",
                icon: "save",
                highlight: "finishBtn"
            }
        ];

        function startTutorial() {
            state.tutorialStep = 0;
            tutorialOverlay.classList.remove('hidden');
            showTutorialStep();
        }

        function showTutorialStep() {
            const step = tutorialSteps[state.tutorialStep];
            document.getElementById('tutorialTitle').innerText = step.title;
            document.getElementById('tutorialText').innerText = step.text;
            document.getElementById('tutorialIcon').innerHTML = `<i data-lucide="${step.icon}" class="w-8 h-8"></i>`;
            
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
            
            const targetEl = document.getElementById(step.highlight);
            if (targetEl) targetEl.classList.add('tutorial-highlight');
            
            document.getElementById('tutorialNext').innerText = state.tutorialStep === tutorialSteps.length - 1 ? "Get Started" : "Next";
            lucide.createIcons();
        }

        document.getElementById('tutorialNext').onclick = () => {
            if (state.tutorialStep < tutorialSteps.length - 1) {
                state.tutorialStep++;
                showTutorialStep();
            } else {
                closeTutorial(true);
            }
        };

        document.getElementById('tutorialSkip').onclick = () => closeTutorial(true);
        helpBtn.onclick = (e) => { e.stopPropagation(); startTutorial(); };

        function closeTutorial(markAsCompleted = false) {
            tutorialOverlay.classList.add('hidden');
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
            if (markAsCompleted) {
                state.tutorialCompleted = true;
                saveData();
            }
        }

        function openConfirm(title, text, actionLabel, onConfirm) {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmText').innerText = text;
            const confirmBtn = document.getElementById('confirmAction');
            confirmBtn.innerText = actionLabel;
            confirmBtn.onclick = () => {
                onConfirm();
                confirmModal.classList.add('hidden');
            };
            confirmModal.classList.remove('hidden');
        }

        function saveSession() {
            const session = {
                label: state.label,
                count: state.count,
                target: state.target,
                userName: state.userName || "Guest",
                date: new Date().toLocaleString(),
                id: Date.now()
            };
            state.history.unshift(session);
            state.count = 0;
            state.userName = ""; 
            updateUI();
            saveData();
            showToast(`Saved for ${session.userName}`);
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-12 left-1/2 -translate-x-1/2 bg-primary text-slate-950 px-6 py-2 rounded-full font-bold shadow-lg z-[100] transition-colors duration-500';
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        function openModal(type) {
            mainModal.classList.remove('hidden');
            const content = document.getElementById('modalContent');
            const editBtn = document.getElementById('editPresetsBtn');
            content.innerHTML = '';
            
            if (type === 'presets') {
                document.getElementById('modalTitle').innerText = state.isEditingPresets ? "Edit Presets" : "Select Tasbeeh";
                editBtn.classList.remove('hidden');
                
                if (state.isEditingPresets) {
                    editBtn.innerHTML = '<i data-lucide="check" class="w-5 h-5"></i>';
                    editBtn.classList.add('bg-primary', 'text-slate-950');
                    editBtn.classList.remove('bg-white/5', 'text-slate-400');
                } else {
                    editBtn.innerHTML = '<i data-lucide="settings-2" class="w-5 h-5"></i>';
                    editBtn.classList.remove('bg-primary', 'text-slate-950');
                    editBtn.classList.add('bg-white/5', 'text-slate-400');
                }

                if (!state.isEditingPresets) {
                    const customBtn = document.createElement('button');
                    customBtn.className = 'w-full text-left p-4 bg-primary-fade border border-primary-fade rounded-xl flex justify-between items-center mb-4';
                    customBtn.innerHTML = `<div><div class="font-bold text-primary">Custom Tasbeeh</div><div class="text-xs text-primary/60">One-time session</div></div><i data-lucide="plus" class="w-4 h-4 text-primary"></i>`;
                    customBtn.onclick = () => { mainModal.classList.add('hidden'); openEditTasbeeh('custom'); };
                    content.appendChild(customBtn);
                } else {
                    const addBtn = document.createElement('button');
                    addBtn.className = 'w-full text-center p-3 border border-dashed border-primary-fade text-primary rounded-xl mb-4 text-xs font-bold hover:bg-primary-fade transition-colors';
                    addBtn.innerText = "+ Add New Preset";
                    addBtn.onclick = () => { mainModal.classList.add('hidden'); openEditTasbeeh('preset'); };
                    content.appendChild(addBtn);
                }

                state.presets.forEach((p, idx) => {
                    const btn = document.createElement('div');
                    btn.className = 'preset-item w-full flex gap-2 items-center';
                    
                    const inner = document.createElement('button');
                    inner.className = `flex-grow text-left p-4 glass rounded-xl flex justify-between items-center ${state.isEditingPresets ? 'opacity-50 cursor-default' : 'hover:bg-white/10'}`;
                    inner.innerHTML = `<div><div class="font-bold">${p.label}</div><div class="text-xs text-slate-400">Target: ${p.target}</div></div>`;
                    
                    if (!state.isEditingPresets) {
                        inner.onclick = () => {
                            state.label = p.label;
                            state.target = p.target;
                            state.count = 0;
                            state.userName = ""; 
                            updateUI();
                            saveData();
                            mainModal.classList.add('hidden');
                        };
                    }

                    btn.appendChild(inner);

                    if (state.isEditingPresets) {
                        const delBtn = document.createElement('button');
                        delBtn.className = 'p-4 bg-red-500/10 text-red-400 rounded-xl hover:bg-red-500/20 transition-colors';
                        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
                        delBtn.onclick = () => {
                            state.presets.splice(idx, 1);
                            saveData();
                            openModal('presets');
                        };
                        btn.appendChild(delBtn);
                    } else {
                        inner.innerHTML += '<i data-lucide="chevron-right" class="w-4 h-4"></i>';
                    }

                    content.appendChild(btn);
                });
            } else if (type === 'theme') {
                document.getElementById('modalTitle').innerText = "Color Theme";
                editBtn.classList.add('hidden');
                
                THEMES.forEach(t => {
                    const btn = document.createElement('button');
                    const isActive = state.currentTheme === t.id;
                    btn.className = `w-full p-4 glass rounded-xl flex items-center justify-between mb-2 ${isActive ? 'border-primary border-2' : ''}`;
                    btn.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-6 h-6 rounded-full ${t.class} bg-primary"></div>
                            <span class="font-bold">${t.label}</span>
                        </div>
                        ${isActive ? '<i data-lucide="check" class="w-4 h-4 text-primary"></i>' : ''}
                    `;
                    btn.onclick = () => {
                        applyTheme(t.id);
                        openModal('theme');
                    };
                    content.appendChild(btn);
                });
            } else {
                document.getElementById('modalTitle').innerText = "History";
                editBtn.classList.add('hidden');
                if (state.history.length === 0) {
                    content.innerHTML = '<p class="text-center text-slate-500 py-8 text-sm">No saved sessions.</p>';
                } else {
                    state.history.forEach(h => {
                        const div = document.createElement('div');
                        div.className = 'p-4 glass rounded-xl mb-2 flex flex-col gap-2';
                        div.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-sm">${h.label}</div>
                                    <div class="text-[10px] text-primary font-bold uppercase tracking-wide">${h.userName || 'Guest'}</div>
                                    <div class="text-[10px] text-slate-500">${h.date}</div>
                                </div>
                                <div class="text-xl font-black text-primary">${h.count}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="resumeItem(${h.id})" class="flex-grow bg-primary-fade text-primary py-2 rounded-lg text-xs font-bold">Continue</button>
                                <button onclick="deleteItem(${h.id})" class="px-3 bg-red-500/10 text-red-400 py-2 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        content.appendChild(div);
                    });
                }
            }
            lucide.createIcons();
        }

        let editMode = 'custom'; 
        function openEditTasbeeh(mode = 'custom') {
            editMode = mode;
            document.getElementById('editTasbeehTitle').innerText = mode === 'custom' ? "Custom Tasbeeh" : "Add New Preset";
            document.getElementById('tasbeehNameInput').value = mode === 'custom' ? state.label : "";
            document.getElementById('tasbeehTargetInput').value = mode === 'custom' ? state.target : 1000;
            editTasbeehModal.classList.remove('hidden');
        }

        window.resumeItem = (id) => {
            const item = state.history.find(h => h.id === id);
            if (item) {
                state.label = item.label;
                state.count = item.count;
                state.target = item.target;
                state.userName = item.userName || ""; 
                state.history = state.history.filter(h => h.id !== id);
                updateUI();
                saveData();
                mainModal.classList.add('hidden');
            }
        };

        window.deleteItem = (id) => {
            state.history = state.history.filter(h => h.id !== id);
            saveData();
            openModal('history');
        };

        document.getElementById('saveNameBtn').onclick = () => {
            const input = document.getElementById('nameInput');
            const name = input.value.trim() || "Guest";
            state.userName = name;
            nameModal.classList.add('hidden');
            updateUI();
            saveData();
            if (state.count > 0) saveSession();
        };

        document.getElementById('saveTasbeehBtn').onclick = () => {
            const nameIn = document.getElementById('tasbeehNameInput');
            const targetIn = document.getElementById('tasbeehTargetInput');
            const label = nameIn.value.trim() || "Tasbeeh";
            const target = parseInt(targetIn.value) || 1000;

            if (editMode === 'custom') {
                state.label = label;
                state.target = target;
                state.count = 0;
                state.userName = "";
                updateUI();
            } else {
                state.presets.push({ label, target });
                setTimeout(() => openModal('presets'), 100);
            }

            editTasbeehModal.classList.add('hidden');
            saveData();
        };

        document.getElementById('editPresetsBtn').onclick = () => {
            state.isEditingPresets = !state.isEditingPresets;
            openModal('presets');
        };

        document.getElementById('resetBtn').onclick = () => {
            openConfirm("Reset Counter?", "Clear current progress?", "Reset", () => {
                state.count = 0;
                state.userName = ""; 
                updateUI();
                saveData();
            });
        };

        userBadge.onclick = () => {
            document.getElementById('nameInput').value = state.userName;
            nameModal.classList.remove('hidden');
        };

        labelContainer.onclick = (e) => { e.stopPropagation(); openEditTasbeeh('custom'); };
        document.getElementById('finishBtn').onclick = () => {
            if (state.count === 0) return;
            if (!state.userName) {
                document.getElementById('nameInput').value = "";
                nameModal.classList.remove('hidden');
                return;
            }
            saveSession();
        };
        document.getElementById('presetBtn').onclick = () => { state.isEditingPresets = false; openModal('presets'); };
        document.getElementById('historyBtn').onclick = () => openModal('history');
        document.getElementById('themeBtn').onclick = () => openModal('theme');
        document.getElementById('closeModal').onclick = () => mainModal.classList.add('hidden');
        document.getElementById('confirmCancel').onclick = () => confirmModal.classList.add('hidden');
        
        tapArea.onpointerdown = increment;

        loadData();
        updateUI();
        lucide.createIcons();
    </script>
</body>
</html>