<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abdulqadir Slatewala Tasbeeh Counter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .counter-glow {
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .tap-active:active {
            transform: scale(0.96);
            transition: transform 0.05s;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }

        #modalContent::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen overflow-hidden flex flex-col">

    <!-- Header & Controls -->
    <header class="p-4 flex flex-col gap-4 z-10 bg-slate-950/80 backdrop-blur-md border-b border-white/5">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center">
                    <i data-lucide="hash" class="w-5 h-5 text-slate-950"></i>
                </div>
                <h1 class="font-semibold text-lg tracking-tight">Tasbeeh Counter</h1>
            </div>
            <div id="userBadge" class="text-[10px] bg-emerald-500/20 px-2 py-1 rounded-full text-emerald-400 font-bold hidden border border-emerald-500/30 cursor-pointer hover:bg-emerald-500/30 transition-colors flex items-center gap-1">
                <span id="badgeName"></span>
                <i data-lucide="user-round-pen" class="w-3 h-3"></i>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="grid grid-cols-4 gap-2">
            <button id="resetBtn" class="glass p-2 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors">
                <i data-lucide="rotate-ccw" class="w-4 h-4 text-orange-400"></i>
                <span class="text-[10px] font-medium">Reset</span>
            </button>
            <button id="presetBtn" class="glass p-2 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors">
                <i data-lucide="list-music" class="w-4 h-4 text-blue-400"></i>
                <span class="text-[10px] font-medium">Presets</span>
            </button>
            <button id="historyBtn" class="glass p-2 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors">
                <i data-lucide="history" class="w-4 h-4 text-purple-400"></i>
                <span class="text-[10px] font-medium">History</span>
            </button>
            <button id="finishBtn" class="glass p-2 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-white/10 transition-colors border-emerald-500/50">
                <i data-lucide="save" class="w-4 h-4 text-emerald-400"></i>
                <span class="text-[10px] font-medium leading-tight">Save</span>
            </button>
        </div>
    </header>

    <!-- Main Interaction Area -->
    <main id="tapArea" class="flex-grow flex flex-col items-center justify-center relative no-select tap-active cursor-pointer p-4">
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-5">
            <div class="w-64 h-64 border-4 border-emerald-500 rounded-full"></div>
        </div>

        <div class="text-center z-10 pointer-events-none flex flex-col items-center gap-2">
            <span id="labelDisplay" class="text-emerald-400 text-sm font-semibold tracking-widest uppercase block">Ya Allah</span>
            <h2 id="counterDisplay" class="text-8xl md:text-9xl font-extrabold counter-glow leading-none">0</h2>
            
            <div class="flex flex-col items-center gap-3">
                <div class="flex flex-col items-center">
                    <p id="targetDisplay" class="text-slate-500 font-medium text-sm">Target: 1000</p>
                    <div id="progressBar" class="w-32 h-1 bg-slate-800 rounded-full overflow-hidden mt-1">
                        <div id="progressFill" class="h-full bg-emerald-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="text-slate-500 text-[10px] uppercase tracking-widest animate-pulse mt-4">
                    Tap anywhere to count
                </div>
            </div>
        </div>
    </main>

    <!-- Main Modal Overlay -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-md rounded-3xl p-6 shadow-2xl border border-white/10">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-xl font-bold">Presets</h3>
                <button id="closeModal" class="p-2 bg-white/5 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="modalContent" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <!-- Name Entry Modal -->
    <div id="nameModal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[60] hidden flex items-center justify-center p-6">
        <div class="bg-slate-900 w-full max-w-sm rounded-3xl p-8 border border-emerald-500/30 shadow-2xl">
            <h3 class="text-2xl font-bold text-center mb-2 text-emerald-400">Tasbeeh Tag</h3>
            <p class="text-slate-400 text-sm text-center mb-6">Enter the name of the person performing this Tasbeeh.</p>
            <input type="text" id="nameInput" placeholder="Enter name" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-4 text-white focus:border-emerald-500 outline-none transition-all text-center mb-4">
            <button id="saveNameBtn" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl transition-all">Save & Finish</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-6">
        <div class="bg-slate-900 w-full max-w-xs rounded-3xl p-6 border border-white/10 text-center">
            <h3 id="confirmTitle" class="text-lg font-bold mb-2">Reset Counter?</h3>
            <p id="confirmText" class="text-slate-400 text-sm mb-6">This action cannot be undone.</p>
            <div class="flex gap-3">
                <button id="confirmCancel" class="flex-1 bg-white/5 hover:bg-white/10 py-3 rounded-xl transition-all">Cancel</button>
                <button id="confirmAction" class="flex-1 bg-red-600 hover:bg-red-500 py-3 rounded-xl transition-all">Reset</button>
            </div>
        </div>
    </div>

    <div id="vibrationFlash" class="fixed inset-0 bg-emerald-500/10 pointer-events-none opacity-0 transition-opacity duration-150"></div>

    <script>
        // State
        let state = {
            count: 0,
            target: 1000,
            label: "Ya Allah",
            userName: "", // This tracks the CURRENT session name
            history: []
        };

        const presets = [
            { label: "Ya Allah", target: 1000 },
            { label: "Ya Mohammed", target: 1000 },
            { label: "Ya Ali", target: 1000 },
            { label: "Ya Fatema", target: 1000 },
            { label: "Ya Hasan", target: 1000 },
            { label: "Ya Hussain", target: 1000 },
            { label: "Astagfirullah", target: 1000 }
        ];

        // UI Helpers
        const counterDisplay = document.getElementById('counterDisplay');
        const tapArea = document.getElementById('tapArea');
        const labelDisplay = document.getElementById('labelDisplay');
        const targetDisplay = document.getElementById('targetDisplay');
        const progressFill = document.getElementById('progressFill');
        const flash = document.getElementById('vibrationFlash');
        const userBadge = document.getElementById('userBadge');
        const badgeName = document.getElementById('badgeName');
        
        // Modals
        const mainModal = document.getElementById('modalOverlay');
        const nameModal = document.getElementById('nameModal');
        const confirmModal = document.getElementById('confirmModal');

        function saveData() {
            localStorage.setItem('tasbeeh_state', JSON.stringify({
                count: state.count,
                target: state.target,
                label: state.label,
                userName: state.userName
            }));
            localStorage.setItem('tasbeeh_history', JSON.stringify(state.history));
        }

        function loadData() {
            const savedState = localStorage.getItem('tasbeeh_state');
            const savedHistory = localStorage.getItem('tasbeeh_history');
            
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.count = parsed.count || 0;
                state.target = parsed.target || 1000;
                state.label = parsed.label || "Ya Allah";
                state.userName = parsed.userName || "";
            }
            if (savedHistory) {
                state.history = JSON.parse(savedHistory);
            }
        }

        function updateUI() {
            counterDisplay.innerText = state.count;
            labelDisplay.innerText = state.label;
            
            if (state.userName) {
                badgeName.innerText = state.userName;
                userBadge.classList.remove('hidden');
            } else {
                userBadge.classList.add('hidden');
            }

            const percent = Math.min((state.count / state.target) * 100, 100);
            progressFill.style.width = `${percent}%`;
            targetDisplay.innerText = `Target: ${state.target}`;
        }

        function triggerHaptic() {
            if (navigator.vibrate) navigator.vibrate(50);
            flash.style.opacity = '1';
            setTimeout(() => flash.style.opacity = '0', 80);
        }

        function increment(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            state.count++;
            if (state.count % 100 === 0 || state.count === state.target) triggerHaptic();
            updateUI();
            saveData();
        }

        function openConfirm(title, text, actionLabel, onConfirm) {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmText').innerText = text;
            const confirmBtn = document.getElementById('confirmAction');
            confirmBtn.innerText = actionLabel;
            confirmBtn.onclick = () => {
                onConfirm();
                confirmModal.classList.add('hidden');
            };
            confirmModal.classList.remove('hidden');
        }

        function startSaveFlow() {
            if (state.count === 0) return;

            // NEW LOGIC: Always ask for name IF current session has no name.
            // If it was continued from history, it will have a state.userName already.
            if (!state.userName) {
                document.getElementById('nameInput').value = "";
                nameModal.classList.remove('hidden');
                return;
            }

            saveSession();
        }

        function saveSession() {
            const session = {
                label: state.label,
                count: state.count,
                target: state.target,
                userName: state.userName || "Guest",
                date: new Date().toLocaleString(),
                id: Date.now()
            };
            state.history.unshift(session);
            state.count = 0;
            state.userName = ""; // Reset current user name for the next new session
            updateUI();
            saveData();
            showToast(`Saved for ${session.userName}`);
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-12 left-1/2 -translate-x-1/2 bg-emerald-600 text-white px-6 py-2 rounded-full font-medium shadow-lg z-[100]';
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        function openModal(type) {
            mainModal.classList.remove('hidden');
            const content = document.getElementById('modalContent');
            content.innerHTML = '';
            
            if (type === 'presets') {
                document.getElementById('modalTitle').innerText = "Select Tasbeeh";
                presets.forEach(p => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-4 glass rounded-xl flex justify-between items-center';
                    btn.innerHTML = `<div><div class="font-bold">${p.label}</div><div class="text-xs text-slate-400">Target: ${p.target}</div></div><i data-lucide="chevron-right" class="w-4 h-4"></i>`;
                    btn.onclick = () => {
                        state.label = p.label;
                        state.target = p.target;
                        state.count = 0;
                        state.userName = ""; // Start fresh name flow for new preset
                        updateUI();
                        saveData();
                        mainModal.classList.add('hidden');
                    };
                    content.appendChild(btn);
                });
            } else {
                document.getElementById('modalTitle').innerText = "History";
                if (state.history.length === 0) {
                    content.innerHTML = '<p class="text-center text-slate-500 py-8">No saved sessions.</p>';
                } else {
                    state.history.forEach(h => {
                        const div = document.createElement('div');
                        div.className = 'p-4 glass rounded-xl mb-2 flex flex-col gap-2';
                        div.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-sm">${h.label}</div>
                                    <div class="text-[10px] text-emerald-400 font-bold uppercase tracking-wide">${h.userName || 'Guest'}</div>
                                    <div class="text-[10px] text-slate-500">${h.date}</div>
                                </div>
                                <div class="text-xl font-black text-emerald-400">${h.count}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="resumeItem(${h.id})" class="flex-grow bg-emerald-600/20 text-emerald-400 py-2 rounded-lg text-xs font-bold">Continue</button>
                                <button onclick="deleteItem(${h.id})" class="px-3 bg-red-500/10 text-red-400 py-2 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        content.appendChild(div);
                    });
                }
            }
            lucide.createIcons();
        }

        window.resumeItem = (id) => {
            const item = state.history.find(h => h.id === id);
            if (item) {
                state.label = item.label;
                state.count = item.count;
                state.target = item.target;
                state.userName = item.userName || ""; // Keep the existing name
                state.history = state.history.filter(h => h.id !== id);
                updateUI();
                saveData();
                mainModal.classList.add('hidden');
                showToast(`Resumed for ${state.userName || 'Guest'}`);
            }
        };

        window.deleteItem = (id) => {
            state.history = state.history.filter(h => h.id !== id);
            saveData();
            openModal('history');
        }

        // Events
        document.getElementById('saveNameBtn').onclick = () => {
            const input = document.getElementById('nameInput');
            const name = input.value.trim() || "Guest";
            state.userName = name;
            nameModal.classList.add('hidden');
            updateUI();
            saveData();
            if (state.count > 0) saveSession();
        };

        document.getElementById('resetBtn').onclick = () => {
            openConfirm("Reset Counter?", "Clear current progress? This will start a new session.", "Reset", () => {
                state.count = 0;
                state.userName = ""; // Reset user for a fresh count
                updateUI();
                saveData();
            });
        };

        userBadge.onclick = () => {
            document.getElementById('nameInput').value = state.userName;
            nameModal.classList.remove('hidden');
        };

        document.getElementById('finishBtn').onclick = startSaveFlow;
        document.getElementById('presetBtn').onclick = () => openModal('presets');
        document.getElementById('historyBtn').onclick = () => openModal('history');
        document.getElementById('closeModal').onclick = () => mainModal.classList.add('hidden');
        document.getElementById('confirmCancel').onclick = () => confirmModal.classList.add('hidden');
        
        tapArea.onpointerdown = increment;

        // Init
        loadData();
        updateUI();
        lucide.createIcons();
    </script>
</body>
</html>